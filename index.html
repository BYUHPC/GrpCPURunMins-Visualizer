<!DOCTYPE html>
<html>
<head>
  <title>SLURM GrpCpuRunMins Simulation</title>
  <link rel="stylesheet" type="text/css" href="simulation.css">
</head>

<body>
  <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.4.6/d3.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
  <script src="./simulation.js"></script>
  
<div id="form-template" style="display: none;">
<form class="base_form" id="simulation{{id}}"> 
    <fieldset>
        <legend>Simulation Parameters #{{id}}</legend>
        <label for="JobWalltimeHours" class="simulation">Job Walltime (hours) <input name="JobWalltimeHours" size="8" type="text" class="simulation"></label> 
        <label for="JobCores" class="simulation">Cores Per Job <input name="JobCores" size="8" type="text" class="simulation"></label>
        <label for="GrpCPURunMins" class="simulation">Group CPU Run Mins <input name="GrpCPURunMins" size="8" type="text" class="simulation"></label>
        <label for="jobs" class="simulation">Jobs <input name="jobs" size="8" type="text" class="simulation"></label> 
    </fieldset>
    <input type="submit" name="submit" value="Update Chart">
    <div>Compare Plots <span id="formadd{{id}}"></span></div>
</form>
</div>

<div id="formset" class="formset"></div>
<div id="graph"><svg xmlns="http://www.w3.org/2000/svg"><defs><style type="text/css">
    <![CDATA[
body {
  background-color: white;
}
.axis path {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}
.axis line {
  fill: none;
  stroke: lightgrey;
  shape-rendering: crispEdges;
  opacity: 0.7;
}

.line {
  fill: none;
  stroke-width: 1.5px;
}

.red {
  stroke: red;
}

.blue {
  stroke: steelblue;
}

.green {
  stroke: green;
}

]]>
</style></defs></svg></div>
<div id="loading" class="loading-spinner">
  <p><img src="/css/nova/simulation/ajax-loader.gif" /> Please Wait</p>
</div>
<button id="save">Save 1</button>
<button id="save8">Save 8</button>
<button onclick="saveAsImg();">Save 2</button>
<div id="svgdataurl"></div>
<div id="pngdataurl"></div>
<script>

var margin = {top: 20, right: 20, bottom: 30, left: 100},
    width = 1080 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;

var x = d3.scale.linear()
    .range([0, width]);

var y = d3.scale.linear()
    .range([height, 0]);

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom");

var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left");

var line = d3.svg.line()
    .x(function(d,i) { return x(i); })
    .y(function(d) { return y(d); });

var svg = d3.select("div#graph").select("svg")
     .attr("width", width + margin.left + margin.right)
     .attr("height", height + margin.top + margin.bottom)
   .append("g")
     .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var current_id = 0;
var plus_template = '<span class="inc button">+</span>';
var minus_template = '<span class="dec button">-</span>';

// want more comparisons? add more colors to this spot
var chart_colors_class = ["blue", "red", "green"];
var max_forms = chart_colors_class.length;

function addFormButtons(id) {
    if (id !== max_forms-1) {
        $("#formadd"+id).append(plus_template);
    }
    if (id !== 0) {
        $("#formadd"+id).append(minus_template);
    }
    // a little wasteful, but it think it is not a big deal
    $(".dec").click(removeForm);
    $(".inc").click(addForm);
}

function removeForm() {
    // can't remove the last form
    if (current_id === 0) {
        return;
    }
    line_data[--current_id] = [];
    $("#simulation"+(current_id)).remove();
    addFormButtons(current_id-1);
    redraw();
}

function addForm() {
    // can't add more forms than we have colors for just cause I said so :p
    // if you REALLY wanna reuse colors you can just find the add color part and mod it over the length
    if (current_id === max_forms) {
        return;
    }

    // for some stupid reason, I can't use replace on the htmlString. Instead
    // I have to do the split join trick to get it to work
    $("#formset").append($('#form-template').html().split("{{id}}").join(current_id));
    $("#simulation"+current_id).addClass(chart_colors_class[current_id]);
    var id = current_id;
    var simulation = document.getElementById('simulation' + id);
    simulation.addEventListener('submit', function(event) {
        event.preventDefault();
        render(simulation, id);
    });
    // remove the buttons from the previous form if any
    if (current_id !== 0) {
        $("#formadd"+(current_id-1)).empty();
    }
    // add form buttons to the new form
    addFormButtons(current_id++);
}

var history_cache = {};
var line_data = new Array(max_forms);
for (var i = 0; i < max_forms; i++) {
  line_data[i] = [];
}
function render(form, id) {
    // TODO: Hide the jobs field and compute it unless they check the advanced buttons
    // TODO: Cache the results for previous histories
    
    //$('#loading').show();
    var data = [];
    var JobWalltime = form.JobWalltimeHours.value;
    var JobCores = form.JobCores.value;
    var GrpCPURunHrs = form.GrpCPURunMins.value;
    var jobs = Fsl.CpuTimeRemaining.calculate_number_of_jobs_to_run(JobWalltime, JobCores, GrpCPURunHrs);
    var simulation = new Fsl.CpuTimeRemaining.Simulation(JobWalltime, JobCores, jobs, GrpCPURunHrs);
    for (var n = simulation.next(); !n.done; n = simulation.next()) {
      data.push(n.value);
    }
    //console.log(JobWalltime + " " + JobCores + " " + GrpCPURunHrs + " " +data);
    //$('#loading').hide();
    line_data[id] = data;
    redraw();
}
function redraw() {
    // determine the x and y min max by finding the biggest x and biggest y in all the lines
    var x_max = d3.max(line_data, function(line) {
            return line.length-1;
        }) || 1.0;
    x.domain([0, x_max]);
    var y_max = d3.max(line_data, function(line) {
            return d3.max(line);
        }) || 1.0;
    y.domain([0, y_max]);
    redrawTicks();
    // need to remove them all and redraw them with the new scale
    svg.selectAll("path.line")
         .remove();
    for (var i = 0; i < current_id; i++) {
        svg.append("path")
             .datum(line_data[i])
             .attr("class", "line " + chart_colors_class[i])
             .attr("d", line);
    }
}
     
function redrawTicks() {
    svg.selectAll("g.x.axis").remove();
    svg.selectAll("g.y.axis").remove();
    svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis.ticks(10)
            .tickSize(-height, 0, 0)
        ).append("text")
            .attr("dx", ".71em")
            .style("text-anchor", "start")
            .attr("y", -6)
            .text("Hours");
    svg.append("g")         
        .attr("class", "y axis")
        .call(yAxis.ticks(10)
            .tickSize(-width, 0, 0)
        ).append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text("Cores");
}

// parse any query string params and if they are all there then we can fill in the
// form and generate a graph in advance with it
var urlParams;
(window.onpopstate = function () {
    var match,
        pl     = /\+/g,  // Regex for replacing addition symbol with a space
        search = /([^&=]+)=?([^&]*)/g,
        decode = function (s) { return decodeURIComponent(s.replace(pl, " ")); },
        query  = window.location.search.substring(1);

    urlParams = {};
    while (match = search.exec(query))
       urlParams[decode(match[1])] = decode(match[2]);
})();
(function(){
    redrawTicks();
    addForm();
    // verify that all the url params both exist and they are all numbers
    //if (urlParams && urlParams["JobWalltimeHours"] && urlParams["JobCores"] && urlParams["GrpCPURunMins"]) {
    if (urlParams) {
        var JobWalltimeHours = parseInt(urlParams["JobWalltimeHours"]) || '';
        var JobCores = parseInt(urlParams["JobCores"]) || '';
        var jobs = parseInt(urlParams["jobs"]) || '';
        var GrpCPURunMins =  parseInt(urlParams["GrpCPURunMins"]) || '';

        var simulation = document.getElementById('simulation0');
        simulation.JobWalltimeHours.value = JobWalltimeHours;
        simulation.JobCores.value = JobCores;
        simulation.jobs.value = jobs;
        simulation.GrpCPURunMins.value = GrpCPURunMins;
        render(simulation, 0);
    }
})();

d3.select("#save8").on("click", saveAsSvg);

function saveAsSvg() {
//    var append = !svg.select("defs");
//    var defs = append ? svg.append("defs") : svg.select("defs");
//    var style = append ? defs.append("style") : defs.select("style");
//    style.html(
}

d3.select("#save").on("click", function(){
    var html = d3.select("svg")
    .attr("version", 1.1)
    .attr("xmlns", "http://www.w3.org/2000/svg")
    .node().parentNode.innerHTML;

    var imgsrc = 'data:image/svg+xml;base64,'+ btoa(html);
    var img = '<img src="'+imgsrc+'">';
    d3.select("#svgdataurl").html(img);

//
//    var canvas = document.querySelector("canvas"),

    var canvas = document.createElement("canvas");
    canvas.width = 1080;
    canvas.height = 500;
    context = canvas.getContext("2d");

    var image = new Image;
    image.src = imgsrc;
    image.onload = function() {
        context.drawImage(image, 0, 0);

        var canvasdata = canvas.toDataURL("image/png");

        var pngimg = '<img src="'+canvasdata+'">';
        d3.select("#pngdataurl").html(pngimg);

        var a = document.createElement("a");
        a.download = "sample.png";
        a.href = canvasdata;
        a.click();
    };
 
});

function saveAsImg() {
//    var canvas = document.createElement("canvas");
//    canvas.width = 1080;
//    canvas.height = 500;
//    var canvas = document.getElementById("save_image");

    var canvas = document.createElement("canvas");
    canvas.width = 1080;
    canvas.height = 500;
    var ctx    = canvas.getContext('2d');

    var data   = document.getElementById("graph").innerHTML;

    var DOMURL = window.URL || window.webkitURL || window;

    var img = new Image();
    var svg = new Blob([data], {type: 'image/svg+xml;charset=utf-8'});
    var url = DOMURL.createObjectURL(svg);

    img.onload = function () {
      ctx.drawImage(img, 0, 0);
        var canvasdata = canvas.toDataURL("image/png");
    var pngimg = '<img src="'+canvasdata+'">';
    d3.select("#pngdataurl").html(pngimg);
//      DOMURL.revokeObjectURL(url);
    };

    img.src = url;
//    window.location = canvas.toDataURL("image/png");
}
</script>
</body>
</html>
